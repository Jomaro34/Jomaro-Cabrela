<!doctype html>
<html lang="pt">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Dicionario_Cinfaes</title>
  <meta name="description" content="Visualizador de PDF em estilo livro (flipbook) com pesquisa e snippets laterais." />

  <!-- jQuery (necessÃ¡rio para turn.js) -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.7.1/jquery.min.js" integrity="sha512-v2CJ7UaYy4JwqLDIrZUI/4hqeoQieOmAZNXBeQyjo21dadnwR+8VYV0r5b3SX6Z5GmwtdJ0rjVf3TLU2P8QXfw==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
  <!-- turn.js (efeito flipbook) -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/turn.js/4.1.0/turn.min.js" integrity="sha512-FxCUIF/2nJw8yJd+RLl1C6nQ1aZQ+0qQw5h2l1y7A0yZptm0w0c0WkKkJmZz5n1K1y8H1fQ9h1b1sifJxJ0bSg==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>

  <!-- PDF.js -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js" integrity="sha512-iM8b2mQwN2z8YgqP0J8o5fB6h0qkJ5w+Uq3k3pP6fR0gJx7bqQmA6hQm1aF4j2iGJc6S0V5k3bG6vQmM2xqzN2w==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
  <script>
    // Worker do PDF.js a partir da CDN
    if (window['pdfjsLib']) {
      pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
    }
  </script>

  <style>
    :root{
      --bg:#0b0f14; --panel:#121821; --soft:#1b2430; --accent:#3b82f6; --muted:#a0aec0; --text:#e5e7eb; --ok:#10b981;
      --shadow:0 10px 30px rgba(0,0,0,.2), inset 0 0 0 1px rgba(255,255,255,.03);
    }
    *{box-sizing:border-box}
    body{margin:0;background:linear-gradient(180deg,var(--bg),#0f1621);color:var(--text);font-family:Inter,system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif;}
    header{display:flex;gap:12px;align-items:center;justify-content:space-between;padding:14px 18px;background:rgba(0,0,0,.25);backdrop-filter:blur(8px);position:sticky;top:0;z-index:10;border-bottom:1px solid rgba(255,255,255,.06)}
    header .title{font-weight:800;letter-spacing:.3px}
    header .title small{display:block;font-weight:500;color:var(--muted)}
    .controls{display:flex;gap:10px;flex-wrap:wrap}
    .input, .btn{border:1px solid rgba(255,255,255,.08);background:var(--panel);color:var(--text);padding:10px 12px;border-radius:12px;box-shadow:var(--shadow)}
    .input{min-width:260px}
    .btn{cursor:pointer;transition:transform .08s ease;}
    .btn:hover{transform:translateY(-1px)}
    .btn.primary{background:linear-gradient(180deg,#2563eb,#1d4ed8);border-color:#1d4ed8}

    main{display:grid;grid-template-columns:360px 1fr;gap:14px;padding:14px;min-height:calc(100vh - 70px)}
    aside{background:var(--panel);border-radius:16px;padding:12px;box-shadow:var(--shadow);display:flex;flex-direction:column;min-height:72vh}
    aside h3{margin:4px 6px 10px;font-size:16px;color:#cbd5e1}
    .searchbar{display:flex;gap:8px;margin:6px}
    .searchbar input{flex:1}
    .results{overflow:auto;flex:1;display:flex;flex-direction:column;gap:8px;padding:6px}
    .result{display:flex;gap:10px;padding:10px;border-radius:12px;background:var(--soft);border:1px solid rgba(255,255,255,.05);cursor:pointer;align-items:center}
    .thumb{width:56px;height:76px;background:#0a0a0a;border-radius:8px;overflow:hidden;border:1px solid rgba(255,255,255,.06);flex:0 0 56px}
    .snippet{font-size:13px;line-height:1.35;color:#d1d5db}
    .snippet mark{background:transparent;color:#fff;border-bottom:2px solid var(--accent)}
    .meta{font-size:12px;color:var(--muted);margin-top:4px}

    .viewerWrap{background:var(--panel);border-radius:16px;padding:12px;box-shadow:var(--shadow);display:grid;grid-template-rows:auto 1fr;gap:10px}
    .toolbar{display:flex;gap:8px;align-items:center;justify-content:space-between}
    .toolbar .left, .toolbar .right{display:flex;gap:8px;align-items:center}
    #flipbook{width:100%;height:80vh;margin:0 auto;background:#111;border-radius:12px;overflow:hidden;border:1px solid rgba(255,255,255,.06)}
    #flipbook .page{background:white}
    .stat{font-size:12px;color:var(--muted)}
    progress{height:10px;width:220px;border-radius:8px;overflow:hidden}

    @media (max-width:1100px){
      main{grid-template-columns:1fr}
      aside{order:2}
    }
  </style>
</head>
<body>
  <header>
    <div class="title">
      Dicionario_Cinfaes
      <small>Flipbook PDF + Pesquisa com snippets</small>
    </div>
    <div class="controls">
      <input id="pdfUrl" class="input" placeholder="URL do PDF (ou /dicionario.pdf)" />
      <button id="btnCarregar" class="btn primary">Carregar PDF</button>
      <button id="btnExemplo" class="btn">Usar exemplo</button>
    </div>
  </header>

  <main>
    <aside>
      <h3>Pesquisa</h3>
      <div class="searchbar">
        <input id="q" class="input" placeholder="Pesquisar no livroâ€¦" />
        <button id="btnPesquisar" class="btn">Procurar</button>
      </div>
      <div class="stat" id="searchStat">Sem pesquisa.</div>
      <div class="results" id="results"></div>
    </aside>

    <section class="viewerWrap">
      <div class="toolbar">
        <div class="left">
          <button class="btn" id="prev">â—€ PÃ¡gina anterior</button>
          <button class="btn" id="next">PÃ¡gina seguinte â–¶</button>
        </div>
        <div class="right">
          <span class="stat">PÃ¡gina <span id="curPage">â€“</span> / <span id="totalPages">â€“</span></span>
          <progress id="progress" value="0" max="100"></progress>
          <span class="stat" id="status">Pronto.</span>
        </div>
      </div>
      <div id="flipbook"></div>
    </section>
  </main>

  <script>
    // ðŸ‘‰ Defina aqui o caminho padrÃ£o do seu PDF hospedado
    const DEFAULT_PDF_URL = 'dicionario.pdf'; // substitua por 'https://seu-dominio.com/Dicionario_Cinfaes.pdf'

    const state = {
      pdf: null,
      totalPages: 0,
      pageCanvases: [],
      pageTexts: [], // texto simples por pÃ¡gina (para pesquisa)
      rendering: false,
      currentPage: 1,
      scaleBase: 1.4 // escala para renderizaÃ§Ã£o principal
    };

    const $flipbook = $('#flipbook');
    const $results = document.getElementById('results');
    const $status = document.getElementById('status');
    const $progress = document.getElementById('progress');
    const $curPage = document.getElementById('curPage');
    const $totalPages = document.getElementById('totalPages');

    function setStatus(msg){ $status.textContent = msg; }
    function setProgress(p){ $progress.value = Math.max(0, Math.min(100, p)); }

    // Carregar PDF
    async function loadPdf(url){
      setStatus('A carregar PDFâ€¦'); setProgress(2);
      try{
        const loadingTask = pdfjsLib.getDocument(url);
        const pdf = await loadingTask.promise;
        state.pdf = pdf;
        state.totalPages = pdf.numPages;
        $totalPages.textContent = state.totalPages;
        state.pageCanvases = new Array(state.totalPages+1);
        state.pageTexts = new Array(state.totalPages+1);
        await buildFlipbookSkeleton();
        await renderAllPagesProgressive();
        attachTurnEvents();
        setStatus('PDF pronto.');
      }catch(err){
        console.error(err);
        alert('Falha ao carregar PDF: ' + err.message);
        setStatus('Erro ao carregar.');
      }
    }

    async function buildFlipbookSkeleton(){
      // Limpa e cria container para turn.js
      $flipbook.html('');
      // PÃ¡ginas pares/Ã­mpares â€“ o turn.js trabalha melhor com nÃºmero par de pÃ¡ginas, ajustamos se necessÃ¡rio
      const total = state.totalPages % 2 === 0 ? state.totalPages : state.totalPages + 1;
      for(let i=1;i<=total;i++){
        const page = $('<div />', { class:'page', 'data-page': i });
        const canvas = document.createElement('canvas');
        canvas.style.width = '100%';
        canvas.style.height = '100%';
        page.append(canvas);
        $flipbook.append(page);
        state.pageCanvases[i] = canvas; // guarda referÃªncia
      }
      // Inicializa turn.js depois de adicionar as pÃ¡ginas
      const width = Math.min(1100, window.innerWidth - 40);
      const height = Math.min(0.8*window.innerHeight, 900);
      $flipbook.turn({
        width: width,
        height: height,
        autoCenter: true,
        display: 'double',
        gradients: true,
        elevation: 50,
      });
      setTimeout(()=> $flipbook.turn('page', 1), 0);
    }

    async function renderAllPagesProgressive(){
      if(!state.pdf) return;
      state.rendering = true;
      for(let pageNum=1; pageNum<=state.totalPages; pageNum++){
        await renderPage(pageNum);
        setProgress( Math.round((pageNum/state.totalPages)*100) );
      }
      state.rendering = false;
    }

    async function renderPage(pageNum){
      const page = await state.pdf.getPage(pageNum);
      const viewport = page.getViewport({ scale: state.scaleBase });
      const canvas = state.pageCanvases[pageNum];
      if(!canvas) return;
      const context = canvas.getContext('2d');
      canvas.width = viewport.width;
      canvas.height = viewport.height;
      await page.render({ canvasContext: context, viewport }).promise;
      // Extrai texto simples para indexaÃ§Ã£o
      const textContent = await page.getTextContent();
      const text = textContent.items.map(it => it.str).join(' ');
      state.pageTexts[pageNum] = text;
      if(pageNum===1){
        $curPage.textContent = '1';
      }
    }

    function debounce(fn, delay=350){
      let t; return (...args)=>{ clearTimeout(t); t=setTimeout(()=>fn(...args), delay); };
    }

    function normalize(s){ return (s||'').toString().normalize('NFD').replace(/\p{Diacritic}/gu,'').toLowerCase(); }

    function findMatches(query){
      const qn = normalize(query);
      const hits = [];
      for(let i=1;i<=state.totalPages;i++){
        const text = state.pageTexts[i];
        if(!text) continue;
        const tn = normalize(text);
        const idx = tn.indexOf(qn);
        if(idx>=0){
          // cria snippet
          const raw = text;
          const start = Math.max(0, idx - 60);
          const end = Math.min(raw.length, idx + query.length + 60);
          const before = raw.slice(start, idx);
          const match = raw.slice(idx, idx+query.length);
          const after = raw.slice(idx+query.length, end);
          hits.push({ page:i, before, match, after });
        }
      }
      return hits;
    }

    async function renderResultThumb(canvasTarget, pageNum){
      const page = await state.pdf.getPage(pageNum);
      const viewport = page.getViewport({ scale: 0.25 });
      const ctx = canvasTarget.getContext('2d');
      canvasTarget.width = viewport.width;
      canvasTarget.height = viewport.height;
      await page.render({ canvasContext: ctx, viewport }).promise;
    }

    function showResults(hits, query){
      $results.innerHTML = '';
      document.getElementById('searchStat').textContent = hits.length ? `${hits.length} resultado(s)` : 'Sem resultados.';
      hits.slice(0, 200).forEach(hit=>{
        const item = document.createElement('div');
        item.className = 'result';
        item.title = `Ir para a pÃ¡gina ${hit.page}`;
        const thumb = document.createElement('canvas');
        thumb.className = 'thumb';
        const textBox = document.createElement('div');
        textBox.style.flex = '1';
        const snippet = document.createElement('div');
        snippet.className = 'snippet';
        snippet.innerHTML = `${hit.before} <mark>${hit.match}</mark> ${hit.after}`;
        const meta = document.createElement('div');
        meta.className = 'meta';
        meta.textContent = `PÃ¡gina ${hit.page}`;
        textBox.appendChild(snippet); textBox.appendChild(meta);
        item.appendChild(thumb); item.appendChild(textBox);
        item.addEventListener('click', ()=> {
          $flipbook.turn('page', hit.page);
          window.scrollTo({ top: document.querySelector('.viewerWrap').offsetTop - 10, behavior:'smooth' });
        });
        $results.appendChild(item);
        // RenderizaÃ§Ã£o do thumbnail em background
        renderResultThumb(thumb, hit.page).catch(console.warn);
      });
    }

    // Eventos UI
    document.getElementById('btnCarregar').addEventListener('click', ()=>{
      const url = document.getElementById('pdfUrl').value.trim() || DEFAULT_PDF_URL;
      loadPdf(url);
    });
    document.getElementById('btnExemplo').addEventListener('click', ()=>{
      document.getElementById('pdfUrl').value = DEFAULT_PDF_URL;
      loadPdf(DEFAULT_PDF_URL);
    });

    document.getElementById('btnPesquisar').addEventListener('click', ()=>{
      const q = document.getElementById('q').value.trim();
      if(!q){ showResults([], ''); return; }
      const hits = findMatches(q);
      showResults(hits, q);
    });

    document.getElementById('q').addEventListener('input', debounce(()=>{
      const q = document.getElementById('q').value.trim();
      if(!q){ showResults([], ''); return; }
      const hits = findMatches(q);
      showResults(hits, q);
    }, 400));

    function attachTurnEvents(){
      $flipbook.on('turning', function(e, page){
        state.currentPage = page;
        $curPage.textContent = page;
      });
      document.getElementById('prev').onclick = ()=> $flipbook.turn('previous');
      document.getElementById('next').onclick = ()=> $flipbook.turn('next');
    }

    // Auto-carregar PDF padrÃ£o se existir
    window.addEventListener('load', ()=>{
      // Tenta carregar automaticamente (pode falhar se nÃ£o existir localmente)
      loadPdf(DEFAULT_PDF_URL).catch(()=> setStatus('Defina o URL do PDF e carregue.'));
    });
  </script>
</body>
</html>
